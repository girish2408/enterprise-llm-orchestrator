# Unified Frontend + Backend Dockerfile
FROM node:20-alpine

# Install pnpm
RUN npm install -g pnpm

# Set working directory
WORKDIR /app

# Copy backend files
COPY package.json pnpm-lock.yaml ./
COPY src/ ./src/
COPY prisma/ ./prisma/
COPY tsconfig.json ./

# Install backend dependencies
RUN pnpm install --frozen-lockfile

# Build backend
RUN pnpm build

# Copy frontend files
COPY frontend/package.json frontend/pnpm-lock.yaml ./
COPY frontend/ ./

# Install frontend dependencies
RUN pnpm install --frozen-lockfile

# Build frontend
RUN pnpm build

# Copy built frontend to backend public directory
RUN mkdir -p dist/public && cp -r dist/* dist/public/ 2>/dev/null || true
RUN cp -r frontend/dist/* dist/public/ 2>/dev/null || true

# Expose port
EXPOSE $PORT

# Start the unified server
CMD ["sh", "-c", "pnpm start:prod"]
